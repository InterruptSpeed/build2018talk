<!DOCTYPE html>
<html>
    <body>
        <div id="app">
            <h2>Hub API</h2>
            <form v-on:submit.prevent="addMessage">
                <input type="text" v-model="newMessage" />
                <input type="submit" value="Send" />
            </form>

            <h2>REST API</h2>
            <form v-on:submit.prevent="addRestMessage">
                <input type="text" v-model="newRestMessage" />
                <input type="submit" value="Send" />
            </form>

            <ul>
                <li v-for="message in messages">{{ message }}</li>
            </ul>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/@aspnet/signalr@1.0.0/dist/browser/signalr.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/msgpack5@4.2.0/dist/msgpack5.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@aspnet/signalr-protocol-msgpack@1.0.0/dist/browser/signalr-protocol-msgpack.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

        <script>
            (async function() {
            const connection = new signalR.HubConnectionBuilder()
                                .withUrl("/app")
                                .withHubProtocol(new signalR.protocols.msgpack.MessagePackHubProtocol())
                                .build();
                const app = new Vue({
                    el: "#app", 
                    data: {
                        messages:[],
                        newMessage: null,
                        newRestMessage: null
                    },
                    methods: {
                        async addMessage() {
                            await connection.invoke("Send", {Message: this.newMessage});
                            this.newMessage = null;
                        },
                        async addRestMessage() {
                            await fetch("/message", {
                                method: "post",
                                body: JSON.stringify({ Message: this.newRestMessage}),
                                headers: {
                                    "content-type" : "application/json"
                                }
                            });
                            this.newRestMessage = null;
                        }
                    }
                })

                connection.on("Send", message => {
                    app.messages.push(message);
                });

                await connection.start();
            })();
        </script>
    </body>
</html>
